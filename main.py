import asyncio
import time
import os
import sys
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from aiogram import Bot
from aiogram.types import FSInputFile
import logging
from datetime import datetime, timedelta

# ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ŸÇÿ±ÿßÿ°ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ŸÖŸÜ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ®Ÿäÿ¶ÿ©
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
if not TELEGRAM_BOT_TOKEN or not TELEGRAM_CHAT_ID:
    logger.error("‚ùå ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ∫Ÿäÿ± ŸÖÿ∂ÿ®Ÿàÿ∑ÿ©!")
    sys.exit(1)

# ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ®Ÿàÿ™
bot = Bot(token=TELEGRAM_BOT_TOKEN)

def format_duration(seconds):
    """ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ´ŸàÿßŸÜŸä ÿ•ŸÑŸâ ÿ™ŸÜÿ≥ŸäŸÇ ŸÖŸÇÿ±Ÿàÿ°"""
    if seconds < 60:
        return f"{seconds:.1f} ÿ´ÿßŸÜŸäÿ©"
    elif seconds < 3600:
        minutes = seconds / 60
        return f"{minutes:.1f} ÿØŸÇŸäŸÇÿ©"
    else:
        hours = seconds / 3600
        minutes = (seconds % 3600) / 60
        return f"{hours:.1f} ÿ≥ÿßÿπÿ© Ÿà {minutes:.0f} ÿØŸÇŸäŸÇÿ©"

def setup_chrome_driver():
    """ÿ•ÿπÿØÿßÿØ Chrome Driver ŸÑŸÄ GitHub Actions"""
    logger.info("üîß ÿ•ÿπÿØÿßÿØ Chrome Driver...")
    
    chrome_options = Options()
    
    # ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ∂ÿ±Ÿàÿ±Ÿäÿ© ŸÑŸÄ GitHub Actions
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--disable-gpu")
    chrome_options.add_argument("--window-size=1920,1080")
    chrome_options.add_argument("--disable-extensions")
    chrome_options.add_argument("--disable-plugins")
    chrome_options.add_argument("--disable-web-security")
    chrome_options.add_argument("--allow-running-insecure-content")
    chrome_options.add_argument("--disable-blink-features=AutomationControlled")
    chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
    chrome_options.add_experimental_option('useAutomationExtension', False)
    chrome_options.add_argument("--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
    
    try:
        driver = webdriver.Chrome(options=chrome_options)
        
        # ÿ•ÿÆŸÅÿßÿ° ÿ£ÿ™ŸÖÿ™ÿ© ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
        driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        
        logger.info("‚úÖ ÿ™ŸÖ ÿ•ÿπÿØÿßÿØ Chrome Driver ÿ®ŸÜÿ¨ÿßÿ≠")
        return driver
    except Exception as e:
        logger.error(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿØÿßÿØ Chrome: {e}")
        sys.exit(1)


# üìä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ© ÿßŸÑŸÖŸèÿ≠ÿØÿ´ÿ© (100 ÿ≥ŸáŸÖ)
STOCKS = [
    {"symbol": "NVDA", "name": "NVIDIA Corporation", "sector": "Electronic technology"},
    {"symbol": "MSFT", "name": "Microsoft Corporation", "sector": "Technology services"},
    {"symbol": "AAPL", "name": "Apple Inc.", "sector": "Electronic technology"},
    {"symbol": "GOOG", "name": "Alphabet Inc.", "sector": "Technology services"},
    {"symbol": "AMZN", "name": "Amazon.com, Inc.", "sector": "Retail trade"},
    {"symbol": "META", "name": "Meta Platforms, Inc.", "sector": "Technology services"},
    {"symbol": "AVGO", "name": "Broadcom Inc.", "sector": "Electronic technology"},
    {"symbol": "BRK.A", "name": "Berkshire Hathaway Inc.", "sector": "Finance"},
    {"symbol": "TSLA", "name": "Tesla, Inc.", "sector": "Consumer durables"},
    {"symbol": "JPM", "name": "JP Morgan Chase & Co.", "sector": "Finance"},
    {"symbol": "WMT", "name": "Walmart Inc.", "sector": "Retail trade"},
    {"symbol": "LLY", "name": "Eli Lilly and Company", "sector": "Health technology"},
    {"symbol": "ORCL", "name": "Oracle Corporation", "sector": "Technology services"},
    {"symbol": "V", "name": "Visa Inc.", "sector": "Finance"},
    {"symbol": "MA", "name": "Mastercard Incorporated", "sector": "Finance"},
    {"symbol": "NFLX", "name": "Netflix, Inc.", "sector": "Technology services"},
    {"symbol": "XOM", "name": "Exxon Mobil Corporation", "sector": "Energy minerals"},
    {"symbol": "COST", "name": "Costco Wholesale Corporation", "sector": "Retail trade"},
    {"symbol": "JNJ", "name": "Johnson & Johnson", "sector": "Health technology"},
    {"symbol": "PLTR", "name": "Palantir Technologies Inc.", "sector": "Technology services"},
    {"symbol": "HD", "name": "Home Depot, Inc. (The)", "sector": "Retail trade"},
    {"symbol": "PG", "name": "Procter & Gamble Company (The)", "sector": "Consumer non-durables"},
    {"symbol": "ABBV", "name": "AbbVie Inc.", "sector": "Health technology"},
    {"symbol": "BAC", "name": "Bank of America Corporation", "sector": "Finance"},
    {"symbol": "CVX", "name": "Chevron Corporation", "sector": "Energy minerals"},
    {"symbol": "KO", "name": "Coca-Cola Company (The)", "sector": "Consumer non-durables"},
    {"symbol": "GE", "name": "GE Aerospace", "sector": "Electronic technology"},
    {"symbol": "AMD", "name": "Advanced Micro Devices, Inc.", "sector": "Electronic technology"},
    {"symbol": "BABA", "name": "Alibaba Group Holding Limited", "sector": "Retail trade"},
    {"symbol": "TMUS", "name": "T-Mobile US, Inc.", "sector": "Communications"},
    {"symbol": "CSCO", "name": "Cisco Systems, Inc.", "sector": "Electronic technology"},
    {"symbol": "PM", "name": "Philip Morris International Inc", "sector": "Consumer non-durables"},
    {"symbol": "WFC", "name": "Wells Fargo & Company", "sector": "Finance"},
    {"symbol": "CRM", "name": "Salesforce, Inc.", "sector": "Technology services"},
    {"symbol": "IBM", "name": "International Business Machines Corporation", "sector": "Technology services"},
    {"symbol": "UNH", "name": "UnitedHealth Group Incorporated", "sector": "Health services"},
    {"symbol": "ABT", "name": "Abbott Laboratories", "sector": "Health technology"},
    {"symbol": "MS", "name": "Morgan Stanley", "sector": "Finance"},
    {"symbol": "LIN", "name": "Linde plc", "sector": "Process industries"},
    {"symbol": "GS", "name": "Goldman Sachs Group, Inc. (The)", "sector": "Finance"},
    {"symbol": "INTU", "name": "Intuit Inc.", "sector": "Technology services"},
    {"symbol": "MCD", "name": "McDonald's Corporation", "sector": "Consumer services"},
    {"symbol": "DIS", "name": "Walt Disney Company (The)", "sector": "Consumer services"},
    {"symbol": "RTX", "name": "RTX Corporation", "sector": "Electronic technology"},
    {"symbol": "AXP", "name": "American Express Company", "sector": "Finance"},
    {"symbol": "BX", "name": "Blackstone Inc.", "sector": "Finance"},
    {"symbol": "CAT", "name": "Caterpillar, Inc.", "sector": "Producer manufacturing"},
    {"symbol": "MRK", "name": "Merck & Company, Inc.", "sector": "Health technology"},
    {"symbol": "T", "name": "AT&T Inc.", "sector": "Communications"},
    {"symbol": "PEP", "name": "PepsiCo, Inc.", "sector": "Consumer non-durables"},
    {"symbol": "NOW", "name": "ServiceNow, Inc.", "sector": "Technology services"},
    {"symbol": "UBER", "name": "Uber Technologies, Inc.", "sector": "Transportation"},
    {"symbol": "VZ", "name": "Verizon Communications Inc.", "sector": "Communications"},
    {"symbol": "BKNG", "name": "Booking Holdings Inc.", "sector": "Consumer services"},
    {"symbol": "GEV", "name": "GE Vernova Inc.", "sector": "Producer manufacturing"},
    {"symbol": "TMO", "name": "Thermo Fisher Scientific Inc", "sector": "Health technology"},
    {"symbol": "SCHW", "name": "Charles Schwab Corporation (The)", "sector": "Finance"},
    {"symbol": "BLK", "name": "BlackRock, Inc.", "sector": "Finance"},
    {"symbol": "SPGI", "name": "S&P Global Inc.", "sector": "Commercial services"},
    {"symbol": "ISRG", "name": "Intuitive Surgical, Inc.", "sector": "Health technology"},
    {"symbol": "C", "name": "Citigroup, Inc.", "sector": "Finance"},
    {"symbol": "BA", "name": "Boeing Company (The)", "sector": "Electronic technology"},
    {"symbol": "TXN", "name": "Texas Instruments Incorporated", "sector": "Electronic technology"},
    {"symbol": "SHOP", "name": "Shopify Inc.", "sector": "Commercial services"},
    {"symbol": "AMGN", "name": "Amgen Inc.", "sector": "Health technology"},
    {"symbol": "QCOM", "name": "QUALCOMM Incorporated", "sector": "Electronic technology"},
    {"symbol": "PDD", "name": "PDD Holdings Inc.", "sector": "Retail trade"},
    {"symbol": "BSX", "name": "Boston Scientific Corporation", "sector": "Health technology"},
    {"symbol": "ACN", "name": "Accenture plc", "sector": "Technology services"},
    {"symbol": "ANET", "name": "Arista Networks, Inc.", "sector": "Electronic technology"},
    {"symbol": "NEE", "name": "NextEra Energy, Inc.", "sector": "Utilities"},
    {"symbol": "SYK", "name": "Stryker Corporation", "sector": "Health technology"},
    {"symbol": "ARM", "name": "Arm Holdings plc", "sector": "Electronic technology"},
    {"symbol": "AMAT", "name": "Applied Materials, Inc.", "sector": "Producer manufacturing"},
    {"symbol": "ADBE", "name": "Adobe Inc.", "sector": "Technology services"},
    {"symbol": "TJX", "name": "TJX Companies, Inc. (The)", "sector": "Retail trade"},
    {"symbol": "DHR", "name": "Danaher Corporation", "sector": "Health technology"},
    {"symbol": "PGR", "name": "Progressive Corporation (The)", "sector": "Finance"},
    {"symbol": "PFE", "name": "Pfizer, Inc.", "sector": "Health technology"},
    {"symbol": "HON", "name": "Honeywell International Inc.", "sector": "Electronic technology"},
    {"symbol": "GILD", "name": "Gilead Sciences, Inc.", "sector": "Health technology"},
    {"symbol": "ETN", "name": "Eaton Corporation, PLC", "sector": "Producer manufacturing"},
    {"symbol": "DE", "name": "Deere & Company", "sector": "Producer manufacturing"},
    {"symbol": "COF", "name": "Capital One Financial Corporation", "sector": "Finance"},
    {"symbol": "LOW", "name": "Lowe's Companies, Inc.", "sector": "Retail trade"},
    {"symbol": "UNP", "name": "Union Pacific Corporation", "sector": "Transportation"},
    {"symbol": "APH", "name": "Amphenol Corporation", "sector": "Electronic technology"},
    {"symbol": "SPOT", "name": "Spotify Technology S.A.", "sector": "Technology services"},
    {"symbol": "APP", "name": "Applovin Corporation", "sector": "Technology services"},
    {"symbol": "KKR", "name": "KKR & Co. Inc.", "sector": "Finance"},
    {"symbol": "LRCX", "name": "Lam Research Corporation", "sector": "Producer manufacturing"},
    {"symbol": "MELI", "name": "MercadoLibre, Inc.", "sector": "Retail trade"},
    {"symbol": "MU", "name": "Micron Technology, Inc.", "sector": "Electronic technology"},
    {"symbol": "ADP", "name": "Automatic Data Processing, Inc.", "sector": "Technology services"},
    {"symbol": "CMCSA", "name": "Comcast Corporation", "sector": "Consumer services"},
    {"symbol": "COP", "name": "ConocoPhillips", "sector": "Energy minerals"},
    {"symbol": "KLAC", "name": "KLA Corporation", "sector": "Electronic technology"},
    {"symbol": "SNPS", "name": "Synopsys, Inc.", "sector": "Technology services"},
    {"symbol": "MDT", "name": "Medtronic plc.", "sector": "Health technology"},
    {"symbol": "WELL", "name": "Welltower Inc.", "sector": "Finance"},
    {"symbol": "PANW", "name": "Palo Alto Networks, Inc.", "sector": "Technology services"},
    {"symbol": "BN", "name": "Brookfield Corporation", "sector": "Finance"},
    {"symbol": "CRWD", "name": "CrowdStrike Holdings, Inc.", "sector": "Technology services"},
    {"symbol": "NKE", "name": "Nike, Inc.", "sector": "Consumer non-durables"},
    {"symbol": "ADI", "name": "Analog Devices, Inc.", "sector": "Electronic technology"},
    {"symbol": "DASH", "name": "DoorDash, Inc.", "sector": "Transportation"},
    {"symbol": "CEG", "name": "Constellation Energy Corporation", "sector": "Utilities"},
    {"symbol": "ICE", "name": "Intercontinental Exchange Inc.", "sector": "Finance"}
]

async def capture_tradingview_chart(stock_info, driver):
    """ÿßŸÑÿ™ŸÇÿßÿ∑ ÿ¥ÿßÿ±ÿ™ ŸÖŸÜ TradingView ŸÑŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ©"""
    symbol = stock_info["symbol"]
    name = stock_info["name"]
    sector = stock_info["sector"]
    
    # ÿ®ÿØÿ° ŸÇŸäÿßÿ≥ ÿßŸÑŸàŸÇÿ™ ŸÑŸÑÿ≥ŸáŸÖ ÿßŸÑŸàÿßÿ≠ÿØ
    chart_start_time = time.time()
    
    logger.info(f"üìà ŸÖÿπÿßŸÑÿ¨ÿ© {name} ({symbol})...")
    
    try:
        # ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ®Ÿàÿ±ÿµÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ≥ŸáŸÖ
        nasdaq_symbols = [
            'AAPL', 'MSFT', 'GOOG', 'GOOGL', 'AMZN', 'META', 'NVDA', 'NFLX', 
            'ADBE', 'CRM', 'ORCL', 'CSCO', 'INTC', 'AMD', 'QCOM', 'AVGO', 
            'TXN', 'COST', 'SBUX', 'PYPL', 'ZOOM', 'DOCU', 'PLTR', 'BABA',
            'TMUS', 'INTU', 'NOW', 'UBER', 'BKNG', 'ISRG', 'SHOP', 'PDD',
            'ANET', 'ARM', 'AMAT', 'PANW', 'CRWD', 'DASH', 'SPOT', 'APP',
            'LRCX', 'MELI', 'MU', 'ADP', 'CMCSA', 'KLAC', 'SNPS', 'WELL'
        ]
        
        # ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ®Ÿàÿ±ÿµÿ©
        if symbol in nasdaq_symbols:
            exchange = "NASDAQ"
        else:
            exchange = "NYSE"
        
        # ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑÿÆÿßÿµÿ© (ŸÖÿ´ŸÑ BRK.A)
        clean_symbol = symbol.replace('.', '-')
        
        url = f"https://www.tradingview.com/chart/?symbol={exchange}%3A{clean_symbol}&interval=1M&style=4&theme=dark"        logger.info(f"üåê ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ: {url}")
        driver.get(url)
        
        # ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        logger.info("‚è≥ ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¥ÿßÿ±ÿ™...")
        time.sleep(20)  # ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ£ÿ∑ŸàŸÑ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        
        # ÿ£ÿÆÿ∞ ŸÑŸÇÿ∑ÿ© ÿ¥ÿßÿ¥ÿ©
        file_name = f"{symbol}_chart.png"
        
        try:
            # ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¥ÿßÿ±ÿ™
            wait = WebDriverWait(driver, 15)
            chart_area = wait.until(
                EC.presence_of_element_located((By.CSS_SELECTOR, ".layout__area--center"))
            )
            
            # ÿ£ÿÆÿ∞ ŸÑŸÇÿ∑ÿ© ÿ¥ÿßÿ¥ÿ© ŸÑŸÑÿ¥ÿßÿ±ÿ™ ŸÅŸÇÿ∑
            chart_area.screenshot(file_name)
            logger.info(f"üì∏ ÿ™ŸÖ ÿßŸÑÿ™ŸÇÿßÿ∑ ÿ¥ÿßÿ±ÿ™ {symbol}")
            
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ±ÿ™ÿå ÿ£ÿÆÿ∞ ŸÑŸÇÿ∑ÿ© ÿ¥ÿßÿ¥ÿ© ŸÉÿßŸÖŸÑÿ©: {e}")
            driver.save_screenshot(file_name)
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖŸÑŸÅ
        if os.path.exists(file_name) and os.path.getsize(file_name) > 1000:
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿµŸàÿ±ÿ©
            photo = FSInputFile(file_name)
            
            # ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ ŸÑŸáÿ∞ÿß ÿßŸÑÿ≥ŸáŸÖ
            chart_duration = time.time() - chart_start_time
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿµŸäÿ© ÿ£ŸàŸÑÿßŸã
            await bot.send_message(
                chat_id=TELEGRAM_CHAT_ID,
                text=f"üìä **ÿ¥ÿßÿ±ÿ™ {name} ({symbol})**\nüè¢ ÿßŸÑŸÇÿ∑ÿßÿπ: {sector}\nüèõÔ∏è ÿßŸÑÿ®Ÿàÿ±ÿµÿ©: {exchange}\nüîó TradingView - ÿ±ŸäŸÜŸÉŸà ÿ¥Ÿáÿ±Ÿä\nüìÖ {time.strftime('%Y-%m-%d %H:%M UTC')}\n‚è±Ô∏è ŸàŸÇÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©: {format_duration(chart_duration)}",
                parse_mode="Markdown"
            )
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿµŸàÿ±ÿ©
            await bot.send_photo(
                chat_id=TELEGRAM_CHAT_ID,
                photo=photo,
                caption=f"üìà {name} ({symbol}) - {sector} | {exchange}"
            )
            
            # ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ
            os.remove(file_name)
            logger.info(f"‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ¥ÿßÿ±ÿ™ {symbol} ÿ®ŸÜÿ¨ÿßÿ≠ ŸÅŸä {format_duration(chart_duration)}")
            return True, chart_duration
            
        else:
            chart_duration = time.time() - chart_start_time
            logger.error(f"‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿµÿ≠Ÿäÿ≠ ŸÑŸÄ {symbol}")
            return False, chart_duration
            
    except Exception as e:
        chart_duration = time.time() - chart_start_time
        logger.error(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© {symbol}: {e}")
        return False, chart_duration

async def send_summary_message(successful_charts, total_duration, chart_durations):
    """ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÑÿÆÿµ ÿ¥Ÿáÿ±Ÿäÿ©"""
    try:
        total_stocks = len(STOCKS)
        success_count = len(successful_charts)
        
        current_date = datetime.now()
        month_names = {
            1: "ŸäŸÜÿßŸäÿ±", 2: "ŸÅÿ®ÿ±ÿßŸäÿ±", 3: "ŸÖÿßÿ±ÿ≥", 4: "ÿ£ÿ®ÿ±ŸäŸÑ",
            5: "ŸÖÿßŸäŸà", 6: "ŸäŸàŸÜŸäŸà", 7: "ŸäŸàŸÑŸäŸà", 8: "ÿ£ÿ∫ÿ≥ÿ∑ÿ≥",
            9: "ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±", 10: "ÿ£ŸÉÿ™Ÿàÿ®ÿ±", 11: "ŸÜŸàŸÅŸÖÿ®ÿ±", 12: "ÿØŸäÿ≥ŸÖÿ®ÿ±"
        }
        current_month = month_names[current_date.month]
        current_year = current_date.year
        
        next_month_num = current_date.month + 1 if current_date.month < 12 else 1
        next_year = current_year if current_date.month < 12 else current_year + 1
        next_month = month_names[next_month_num]
        
        # ÿ≠ÿ≥ÿßÿ® ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸàŸÇÿ™ ŸÑŸÉŸÑ ÿ≥ŸáŸÖ
        avg_time_per_chart = sum(chart_durations) / len(chart_durations) if chart_durations else 0
        
        # ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿ∑ÿßÿπ
        sectors = {}
        for stock in successful_charts:
            sector = stock['sector']
            if sector not in sectors:
                sectors[sector] = []
            sectors[sector].append(f"{stock['name']} ({stock['symbol']})")
        
        sectors_summary = ""
        for sector, stocks in sectors.items():
            sectors_summary += f"\nüè¢ **{sector}:**\n"
            for stock in stocks:
                sectors_summary += f"  ‚Ä¢ {stock}\n"
        
        summary = f"""
üá∫üá∏ **ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä - ÿ®Ÿàÿ™ ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ©**
üìÖ ÿßŸÑÿ¥Ÿáÿ±: {current_month} {current_year}
üïí ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™: {time.strftime('%Y-%m-%d %H:%M UTC')}

üìä **ŸÜÿ™ÿßÿ¶ÿ¨ Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±:**
‚úÖ ŸÜÿ¨ÿ≠: {success_count}/{total_stocks}
‚ùå ŸÅÿ¥ŸÑ: {total_stocks - success_count}/{total_stocks}

‚è±Ô∏è **ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸàŸÇÿ™:**
üïê ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ: {format_duration(total_duration)}
üìà ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸàŸÇÿ™ ŸÑŸÉŸÑ ÿ¥ÿßÿ±ÿ™: {format_duration(avg_time_per_chart)}
‚ö° ÿ£ÿ≥ÿ±ÿπ ÿ¥ÿßÿ±ÿ™: {format_duration(min(chart_durations)) if chart_durations else "ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠"}
üêå ÿ£ÿ®ÿ∑ÿ£ ÿ¥ÿßÿ±ÿ™: {format_duration(max(chart_durations)) if chart_durations else "ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠"}

‚úÖ **ÿßŸÑÿ¥ÿßÿ±ÿ™ÿßÿ™ ÿßŸÑŸÖŸèÿ±ÿ≥ŸÑÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿ∑ÿßÿπ:**{sectors_summary}

üìà **ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:**
‚Ä¢ ÿßŸÑŸÖÿµÿØÿ±: TradingView
‚Ä¢ ÿßŸÑÿ®Ÿàÿ±ÿµÿ©: NASDAQ/NYSE
‚Ä¢ ÿßŸÑÿ•ÿ∑ÿßÿ± ÿßŸÑÿ≤ŸÖŸÜŸä: 1 ÿ¥Ÿáÿ±
‚Ä¢ ŸÜŸàÿπ ÿßŸÑÿ¥ÿßÿ±ÿ™: Renko

üîÑ **ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ:** 
üìÖ ÿ£ŸàŸÑ ŸäŸàŸÖ ŸÖŸÜ ÿ¥Ÿáÿ± {next_month} {next_year}
üïí ÿßŸÑÿ≥ÿßÿπÿ© 3:00 ÿµÿ®ÿßÿ≠ÿßŸã (UTC)

ü§ñ **ÿßŸÑŸÖÿµÿØÿ±:** GitHub Actions Bot
üí° **ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®Ÿàÿ™:** ŸÜÿ¥ÿ∑ ŸàŸäÿπŸÖŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        """.strip()
        
        await bot.send_message(
            chat_id=TELEGRAM_CHAT_ID,
            text=summary,
            parse_mode="Markdown"
        )
        
        logger.info("üìã ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä")
        
    except Exception as e:
        logger.error(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖŸÑÿÆÿµ: {e}")

async def send_monthly_greeting():
    """ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ±ÿ≠Ÿäÿ® ÿ¥Ÿáÿ±Ÿäÿ©"""
    try:
        current_date = datetime.now()
        month_names = {
            1: "ŸäŸÜÿßŸäÿ±", 2: "ŸÅÿ®ÿ±ÿßŸäÿ±", 3: "ŸÖÿßÿ±ÿ≥", 4: "ÿ£ÿ®ÿ±ŸäŸÑ",
            5: "ŸÖÿßŸäŸà", 6: "ŸäŸàŸÜŸäŸà", 7: "ŸäŸàŸÑŸäŸà", 8: "ÿ£ÿ∫ÿ≥ÿ∑ÿ≥",
            9: "ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±", 10: "ÿ£ŸÉÿ™Ÿàÿ®ÿ±", 11: "ŸÜŸàŸÅŸÖÿ®ÿ±", 12: "ÿØŸäÿ≥ŸÖÿ®ÿ±"
        }
        current_month = month_names[current_date.month]
        current_year = current_date.year
        
        # ÿ™ŸÇÿØŸäÿ± ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ŸàŸÇÿπ (ÿ≠ŸàÿßŸÑŸä 45 ÿ´ÿßŸÜŸäÿ© ŸÑŸÉŸÑ ÿ≥ŸáŸÖ)
        estimated_time = len(STOCKS) * 45  # ÿ´ÿßŸÜŸäÿ©
        estimated_duration = format_duration(estimated_time)
        
        greeting = f"""
üöÄ **ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÑŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ©!**

üìÖ **{current_month} {current_year}**
üïí ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ: {time.strftime('%Y-%m-%d %H:%M UTC')}

üìä **ŸÖÿß ÿ≥Ÿäÿ™ŸÖ ÿπŸÖŸÑŸá:**
‚Ä¢ ÿ™ÿµŸàŸäÿ± ÿ¥ÿßÿ±ÿ™ÿßÿ™ ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ© ÿπŸÑŸâ ŸÅÿ±ŸäŸÖ ÿ¥Ÿáÿ±Ÿä ÿ±ŸäŸÜŸÉŸà Ÿàÿ•ÿ±ÿ≥ÿßŸÑŸá ÿπŸÑŸâ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ®ÿ¥ŸÉŸÑ ÿ¥Ÿáÿ±Ÿä
‚Ä¢ ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ŸáŸÖ: {len(STOCKS)} ÿ≥ŸáŸÖ ÿ£ŸÖÿ±ŸäŸÉŸä
‚Ä¢ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ŸàŸÇÿπ ŸÑŸÑÿ•ŸÜÿ™Ÿáÿßÿ°: {estimated_duration}

üè¢ **ÿßŸÑŸÇÿ∑ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ¥ŸÖŸàŸÑÿ©:**
‚Ä¢ ÿßŸÑÿ™ŸÉŸÜŸàŸÑŸàÿ¨Ÿäÿß ŸàÿßŸÑÿ®ÿ±ŸÖÿ¨Ÿäÿßÿ™
‚Ä¢ ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ© ŸàÿßŸÑŸÖÿµÿ±ŸÅŸäÿ©
‚Ä¢ ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ© ŸàÿßŸÑÿ£ÿØŸàŸäÿ©
‚Ä¢ ÿßŸÑÿ™ÿ¨ÿßÿ±ÿ© ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿ© ŸàÿßŸÑÿ™ÿ¨ÿ≤ÿ¶ÿ©
‚Ä¢ ÿßŸÑÿ∑ÿßŸÇÿ© ŸàÿßŸÑÿßÿ™ÿµÿßŸÑÿßÿ™
‚Ä¢ Ÿàÿ£ŸÉÿ´ÿ±...

‚è≥ **ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...**
Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ŸäŸÜŸÖÿß ŸÜÿ¨ŸÑÿ® ÿ£ÿ≠ÿØÿ´ ÿßŸÑÿ¥ÿßÿ±ÿ™ÿßÿ™ ŸÑŸÉ
        """.strip()
        
        await bot.send_message(
            chat_id=TELEGRAM_CHAT_ID,
            text=greeting,
            parse_mode="Markdown"
        )
        
        logger.info("üëã ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ® ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©")
        
    except Exception as e:
        logger.error(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®: {e}")

async def send_progress_update(current_index, total_stocks, elapsed_time, successful_count, failed_count):
    """ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÇÿØŸÖ ŸÉŸÑ 10 ÿ£ÿ≥ŸáŸÖ"""
    try:
        progress_percentage = (current_index / total_stocks) * 100
        avg_time_per_stock = elapsed_time / current_index if current_index > 0 else 0
        remaining_stocks = total_stocks - current_index
        estimated_remaining_time = remaining_stocks * avg_time_per_stock
        
        progress_message = f"""
üìä **ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÇÿØŸÖ - ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ©**

üîÑ **ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:**
‚Ä¢ ÿ™ŸÖ ÿ•ŸÜÿ¨ÿßÿ≤: {current_index}/{total_stocks} ({progress_percentage:.1f}%)
‚Ä¢ ŸÜÿ¨ÿ≠: {successful_count} | ŸÅÿ¥ŸÑ: {failed_count}

‚è±Ô∏è **ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸàŸÇÿ™:**
‚Ä¢ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸÜŸÇÿ∂Ÿä: {format_duration(elapsed_time)}
‚Ä¢ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸàŸÇÿ™ ŸÑŸÉŸÑ ÿ≥ŸáŸÖ: {format_duration(avg_time_per_stock)}
‚Ä¢ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑŸÖÿ™ŸàŸÇÿπ: {format_duration(estimated_remaining_time)}

üöÄ **ÿßŸÑÿ™ŸÇÿØŸÖ:** {"‚ñà" * int(progress_percentage // 5)}{"‚ñë" * (20 - int(progress_percentage // 5))} {progress_percentage:.1f}%
        """.strip()
        
        await bot.send_message(
            chat_id=TELEGRAM_CHAT_ID,
            text=progress_message,
            parse_mode="Markdown"
        )
        
        logger.info(f"üìä ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÇÿØŸÖ: {current_index}/{total_stocks}")
        
    except Exception as e:
        logger.error(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÇÿØŸÖ: {e}")

async def main():
    """ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©"""
    # ÿ®ÿØÿ° ŸÇŸäÿßÿ≥ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
    total_start_time = time.time()
    
    logger.info("üöÄ ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ®Ÿàÿ™ ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ© ÿßŸÑÿ¥Ÿáÿ±Ÿä...")
    
    await send_monthly_greeting()
    
    driver = setup_chrome_driver()
    successful_charts = []
    failed_charts = []
    chart_durations = []  # ŸÑÿ≠ŸÅÿ∏ ÿ£ŸàŸÇÿßÿ™ ŸÉŸÑ ÿ¥ÿßÿ±ÿ™
    
    try:
        for i, stock_info in enumerate(STOCKS):
            logger.info(f"üîÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ŸáŸÖ {i+1}/{len(STOCKS)}: {stock_info['name']}")
            
            success, duration = await capture_tradingview_chart(stock_info, driver)
            chart_durations.append(duration)
            
            if success:
                successful_charts.append(stock_info)
            else:
                failed_charts.append(stock_info)
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÇÿØŸÖ ŸÉŸÑ 10 ÿ£ÿ≥ŸáŸÖ
            if (i + 1) % 10 == 0 or (i + 1) == len(STOCKS):
                elapsed_time = time.time() - total_start_time
                await send_progress_update(
                    i + 1, 
                    len(STOCKS), 
                    elapsed_time, 
                    len(successful_charts), 
                    len(failed_charts)
                )
            
            if i < len(STOCKS) - 1:
                logger.info("‚è≥ ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ŸäŸÜ ÿßŸÑÿ£ÿ≥ŸáŸÖ...")
                time.sleep(10)
        
        # ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
        total_duration = time.time() - total_start_time
        
        await send_summary_message(successful_charts, total_duration, chart_durations)
        
        if failed_charts:
            failed_list = "\n".join([f"‚Ä¢ {info['name']} ({info['symbol']}) - {info['sector']}" for info in failed_charts])
            await bot.send_message(
                chat_id=TELEGRAM_CHAT_ID,
                text=f"‚ö†Ô∏è **ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ™Ÿä ŸÅÿ¥ŸÑ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ™Ÿáÿß:**\n{failed_list}\n\nüîß ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÅŸä ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÇÿßÿØŸÖ",
                parse_mode="Markdown"
            )
                
    except Exception as e:
        total_duration = time.time() - total_start_time
        logger.error(f"‚ùå ÿÆÿ∑ÿ£ ÿπÿßŸÖ: {e}")
        
        try:
            error_message = f"""
‚ùå **ÿÆÿ∑ÿ£ ŸÅŸä ÿ®Ÿàÿ™ ÿßŸÑÿ£ÿ≥ŸáŸÖ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸäÿ© ÿßŸÑÿ¥Ÿáÿ±Ÿä**

üïí ÿßŸÑŸàŸÇÿ™: {time.strftime('%Y-%m-%d %H:%M UTC')}
‚è±Ô∏è ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸÜŸÇÿ∂Ÿä ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ∑ÿ£: {format_duration(total_duration)}
üìã ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£:

{str(e)}

üîß **ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™:**
‚Ä¢ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÅŸä ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ
‚Ä¢ ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© GitHub Actions
‚Ä¢ ÿ±ÿßÿ¨ÿπ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ŸÑŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            """.strip()
            
            await bot.send_message(
                chat_id=TELEGRAM_CHAT_ID,
                text=error_message,
                parse_mode="Markdown"
            )
        except:
            logger.error("ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£")
        
    finally:
        try:
            driver.quit()
            logger.info("üîí ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ Chrome Driver")
        except:
            logger.warning("‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∫ŸÑÿßŸÇ Driver")
            
        try:
            await bot.session.close()
            logger.info("üîí ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿ®Ÿàÿ™")
        except:
            logger.warning("‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿ®Ÿàÿ™")
        
        # ÿ≠ÿ≥ÿßÿ® Ÿàÿπÿ±ÿ∂ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä
        final_total_duration = time.time() - total_start_time
        logger.info(f"üèÅ ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ¥Ÿáÿ±Ÿä - ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: {format_duration(final_total_duration)}")

if __name__ == "__main__":
    asyncio.run(main())
